name: Build Windows EXE

on:
  push:
    branches: [ main, feat/re-mosaic ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: Install system dependencies
      run: |
        choco install ffmpeg -y
      shell: pwsh
    
    - name: Install uv
      run: |
        pip install uv
    
    - name: Create virtual environment
      run: |
        uv venv --python 3.13 venv
        
    - name: Install dependencies
      run: |
        .\venv\Scripts\Activate.ps1
        uv pip install -r lada-v0.9.0/lada/packaging/windows/requirements.txt --extra-index-url https://download.pytorch.org/whl/cu128
        uv pip install pyinstaller==6.16.0
        uv pip install Pillow  # Required for icon format conversion
        deactivate
      shell: powershell
    
    - name: Download model weights
      run: |
        $modelDir = "lada-v0.9.0/lada/model_weights"
        New-Item -ItemType Directory -Path $modelDir -Force -ErrorAction SilentlyContinue | Out-Null
        
        # Create placeholder model files to satisfy PyInstaller
        $models = @(
            "lada_mosaic_detection_model_v2.pt",
            "lada_mosaic_detection_model_v3.1_accurate.pt", 
            "lada_mosaic_detection_model_v3.1_fast.pt",
            "lada_mosaic_restoration_model_generic_v1.2.pth"
        )
        
        foreach ($model in $models) {
            $outPath = Join-Path $modelDir $model
            if (!(Test-Path $outPath)) {
                Write-Host "Creating placeholder: $model"
                # Create empty file as placeholder
                New-Item -ItemType File -Path $outPath -Force | Out-Null
            }
        }
        
        # Create 3rd_party directory and placeholder
        $dir3rd = Join-Path $modelDir "3rd_party"
        New-Item -ItemType Directory -Path $dir3rd -Force -ErrorAction SilentlyContinue | Out-Null
        
        $out3rd = Join-Path $dir3rd "clean_youknow_video.pth"
        if (!(Test-Path $out3rd)) {
            New-Item -ItemType File -Path $out3rd -Force | Out-Null
        }
        
        Write-Host "Model weights placeholders created successfully"
      shell: powershell
    
    - name: Build executable
      run: |
        cd lada-v0.9.0/lada
        ..\..\venv\Scripts\Activate.ps1
        pyinstaller --noconfirm ./packaging/windows/lada.spec
        deactivate
      shell: powershell
    
    - name: Create 7z archive
      run: |
        cd lada-v0.9.0/lada
        $version = (..\..\venv\Scripts\python.exe -c "import lada; print(lada.VERSION)")
        
        # Install 7-zip if needed
        choco install 7zip -y
        
        $archivePath = "./dist/lada-$version.7z"
        7z a "$archivePath" "./dist/lada"
        
        # Get SHA256 hash
        $hash = (Get-FileHash -Algorithm SHA256 "$archivePath").Hash.ToLower()
        Add-Content -Path "$archivePath.sha256" -Value "$hash  lada-$version.7z"
      shell: powershell
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lada-windows-exe
        path: lada-v0.9.0/lada/dist/lada-*.7z*
        retention-days: 30
