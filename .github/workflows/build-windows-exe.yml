name: Build Windows EXE

on:
  push:
    branches: [ main, feat/re-mosaic ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: Install system dependencies
      run: |
        choco install ffmpeg -y
      shell: pwsh
    
    - name: Install uv
      run: |
        pip install uv
    
    - name: Create virtual environment
      run: |
        uv venv --python 3.13 venv
        
    - name: Install dependencies
      run: |
        .\venv\Scripts\Activate.ps1
        uv pip install -r lada-v0.9.0/lada/packaging/windows/requirements.txt --extra-index-url https://download.pytorch.org/whl/cu128
        uv pip install pyinstaller==6.16.0
        uv pip install Pillow  # Required for icon format conversion
        deactivate
      shell: powershell
    
    - name: Download model weights
      run: |
        $modelDir = "lada-v0.9.0/lada/model_weights"
        New-Item -ItemType Directory -Path $modelDir -Force -ErrorAction SilentlyContinue | Out-Null
        
        # Download actual model files
        $models = @(
            @{ Url = "https://huggingface.co/ladaapp/lada/resolve/main/lada_mosaic_detection_model_v2.pt?download=true"; Name = "lada_mosaic_detection_model_v2.pt" },
            @{ Url = "https://huggingface.co/ladaapp/lada/resolve/main/lada_mosaic_detection_model_v3.1_accurate.pt?downloadÊûÅ=true"; Name = "lada_mosaic_detection_model_v3.1_accurate.pt" },
            @{ Url = "https://huggingface.co/ladaapp/lada/resolve/main/lada_mosaic_detection_model_v3.1_fast.pt?download=true"; Name = "lada_mosaic_detection_model_v3.1_fast.pt" },
            @{ Url = "https://huggingface.co/ladaapp/lada/resolve/main/lada_mosaic_restoration_model_generic_v1.2.pth?download=true"; Name = "lada_mosaic_restoration_model_generic_v1.2.pth" }
        )
        
        foreach ($model in $models) {
            $outPath = Join-Path $modelDir $model.Name
            if (!(Test-Path $outPath)) {
                Write-Host "Downloading $($model.Name)..."
                Invoke-WebRequest -Uri $model.Url -OutFile $outPath
            }
        }
        
        # Download third-party models
        $dir3rd = Join-Path $modelDir "3rd_party"
        New-Item -ItemType Directory -Path $dir3rd -Force -ErrorAction SilentlyContinue | Out-Null
        
        $out3rd = Join-Path $dir3rd "clean_youknow_video.pth"
        if (!(Test-Path $out3rd)) {
            Write-Host "Downloading clean_youknow_video.pth..."
            Invoke-WebRequest -Uri "https://drive.usercontent.google.com/download?id=1ulct4RhRxQp1v5xwEmUH7xz7AK42Oqlw&export=download&confirm=t" -OutFile $out3rd
        }
        
        Write-Host "All model weights downloaded successfully"
      shell: powershell
    
    - name: Build executable
      run: |
        cd lada-v0.9.0/lada
        ..\..\venv\Scripts\Activate.ps1
        pyinstaller --noconfirm ./packaging/windows/lada.spec
        deactivate
      shell: powershell
    
    - name: Create 7z archive
      run: |
        cd lada-v0.9.0/lada
        $version = (..\..\venv\Scripts\python.exe -c "import lada; print(lada.VERSION)")
        
        # Install 7-zip if needed
        choco install 7zip -y
        
        $archivePath = "./dist/lada-$version.7z"
        7z a "$archivePath" "./dist/lada"
        
        # Get SHA256 hash
        $hash = (Get-FileHash -Algorithm SHA256 "$archivePath").Hash.ToLower()
        Add-Content -Path "$archivePath.sha256" -Value "$hash  lada-$version.7z"
      shell: powershell
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lada-windows-exe
        path: lada-v0.9.0/lada/dist/lada-*.7z*
        retention-days: 30
